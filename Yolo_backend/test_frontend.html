<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI健身助手 - 视频处理测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .video-container {
            margin-top: 20px;
            text-align: center;
        }
        video {
            max-width: 100%;
            height: auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .section-title {
            margin-top: 0;
            color: #555;
        }
        #streamVideo {
            width: 100%;
            max-width: 640px;
            height: auto;
            background-color: #000;
        }
        #streamStats {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        /* 添加一些样式 */
        .record-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        .feedback-details {
            grid-column: span 2;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .feedback-details pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: monospace;
        }
        .video-stream-container {
            position: relative;
            margin: 20px 0;
        }

        .stream-canvas {
            max-width: 100%;
            background-color: #000;
            display: block;
        }

        .stream-controls {
            margin-top: 10px;
        }

        .stream-status {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI健身助手 - 视频处理测试</h1>

        <!-- 现有功能测试 -->
        <div class="section">
            <h2 class="section-title">直接处理视频</h2>
            <form id="directProcessForm">
                <div class="form-group">
                    <label for="directPoseType">动作类型:</label>
                    <select id="directPoseType">
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="deadlift">硬拉</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="directVideoFile">选择视频:</label>
                    <input type="file" id="directVideoFile" accept="video/*" required>
                </div>
                <button type="submit" id="directProcessBtn">处理视频</button>
            </form>
            <div id="directResult" class="result"></div>
        </div>

        <!-- 流式处理视频 -->
        <div class="section">
            <h2 class="section-title">流式处理视频</h2>
            <form id="streamProcessForm">
                <div class="form-group">
                    <label for="streamPoseType">动作类型:</label>
                    <select id="streamPoseType">
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="deadlift">硬拉</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="streamVideoFile">选择视频:</label>
                    <input type="file" id="streamVideoFile" accept="video/*" required>
                </div>
                <button type="submit" id="streamProcessBtn">流式处理视频</button>
            </form>
            <div id="streamVideoContainer" class="video-container">
                <img id="streamVideo" alt="流式视频处理结果" style="display: none;">
            </div>
            <div id="streamStats"></div>
            <div id="streamResult" class="result"></div>
        </div>

        <!-- 新功能测试 -->
        <div class="section">
            <h2 class="section-title">处理并保存视频</h2>
            <form id="saveProcessForm">
                <div class="form-group">
                    <label for="homeworkId">作业ID:</label>
                    <input type="text" id="homeworkId" placeholder="请输入作业ID" required>
                </div>
                <div class="form-group">
                    <label for="studentId">学生ID:</label>
                    <input type="text" id="studentId" placeholder="请输入学生ID" required>
                </div>
                <div class="form-group">
                    <label for="poseType">动作类型:</label>
                    <select id="poseType">
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="deadlift">硬拉</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="videoFile">选择视频:</label>
                    <input type="file" id="videoFile" accept="video/*" required>
                </div>
                <button type="submit" id="saveProcessBtn">处理并保存视频</button>
            </form>
            <div id="saveResult" class="result"></div>
        </div>

        <!-- 查看已处理视频 -->
        <div class="section">
            <h2 class="section-title">查看已处理视频</h2>
            <form id="viewVideoForm">
                <div class="form-group">
                    <label for="viewHomeworkId">作业ID:</label>
                    <input type="text" id="viewHomeworkId" placeholder="请输入作业ID" required>
                </div>
                <div class="form-group">
                    <label for="viewStudentId">学生ID:</label>
                    <input type="text" id="viewStudentId" placeholder="请输入学生ID" required>
                </div>
                <button type="submit" id="viewVideoBtn">查看视频</button>
            </form>
            <div id="processedVideoContainer" class="video-container">
                <video id="processedVideo" controls style="display: none;">
                    您的浏览器不支持视频标签。
                </video>
            </div>
        </div>

        <!-- 删除作业 -->
        <div class="section">
            <h2 class="section-title">删除作业</h2>
            <form id="deleteHomeworkForm">
                <div class="form-group">
                    <label for="deleteHomeworkId">作业ID:</label>
                    <input type="text" id="deleteHomeworkId" placeholder="请输入要删除的作业ID" required>
                </div>
                <button type="submit" id="deleteHomeworkBtn">删除作业</button>
            </form>
            <div id="deleteResult" class="result"></div>
        </div>

        <!-- 查询作业记录 -->
        <div class="section">
            <h2 class="section-title">查询作业记录</h2>
            <form id="queryRecordForm">
                <div class="form-group">
                    <label for="queryHomeworkId">作业ID:</label>
                    <input type="text" id="queryHomeworkId" placeholder="请输入作业ID" required>
                </div>
                <div class="form-group">
                    <label for="queryStudentId">学生ID:</label>
                    <input type="text" id="queryStudentId" placeholder="请输入学生ID" required>
                </div>
                <div class="form-group">
                    <label for="queryPoseType">动作类型:</label>
                    <select id="queryPoseType">
                        <option value="">全部</option>
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="deadlift">硬拉</option>
                    </select>
                </div>
                <button type="submit" id="queryRecordBtn">查询记录</button>
                <button type="button" id="queryAllRecordsBtn">查询所有记录</button>
            </form>
            <div id="queryResult" class="result">
                <table id="recordsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>作业ID</th>
                            <th>学生ID</th>
                            <th>动作类型</th>
                            <th>上传时间</th>
                            <th>总次数</th>
                            <th>正确次数</th>
                            <th>错误次数</th>
                            <th>准确率</th>
                            <th>视频时长(秒)</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 在原HTML的查询作业记录部分添加以下内容 -->
        <div class="section">
            <h2 class="section-title">详细查看记录</h2>
            <div class="form-group">
                <label for="detailHomeworkId">作业ID:</label>
                <input type="text" id="detailHomeworkId" placeholder="请输入作业ID">

                <label for="detailStudentId">学生ID:</label>
                <input type="text" id="detailStudentId" placeholder="请输入学生ID">

                <button onclick="getRecordDetailsByHomeworkStudent()">查看详情</button>
            </div>
            <div id="recordDetailsByHomeworkStudent" class="result"></div>
        </div>

        <!-- 查询记录详情 -->
        <div class="section">
            <h2 class="section-title">查询记录详情</h2>
            <form id="queryDetailsForm">
                <div class="form-group">
                    <label for="recordId">记录ID:</label>
                    <input type="number" id="recordId" placeholder="输入记录ID">
                </div>
                <div class="form-group">
                    <label for="homeworkIdDetail">作业ID:</label>
                    <input type="text" id="homeworkIdDetail" placeholder="输入作业ID">
                </div>
                <div class="form-group">
                    <label for="studentIdDetail">学生ID:</label>
                    <input type="text" id="studentIdDetail" placeholder="输入学生ID">
                </div>
                <button type="button" onclick="getRecordDetails()">查询记录详情</button>
                <button type="button" onclick="getAllRecords()">查询所有记录</button>
            </form>
            <div id="recordDetails" class="result"></div>
        </div>

        <!-- 新增：获取学生所有记录 -->
        <div class="section">
            <h2 class="section-title">获取学生所有记录</h2>
            <form id="allRecordsForm">
                <div class="form-group">
                    <label for="studentIdForAllRecords">学生ID:</label>
                    <input type="text" id="studentIdForAllRecords" placeholder="输入学生ID">
                </div>
                <button type="button" onclick="getStudentAllRecords()">获取学生所有记录</button>
            </form>
            <div id="allRecordsDetails" class="result"></div>
        </div>
    </div>

    <script>
        // 设置基础URL
        const BASE_URL = 'http://118.25.145.4:8000';

        // 直接处理视频
        document.getElementById('directProcessForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const poseType = document.getElementById('directPoseType').value;
            const videoFile = document.getElementById('directVideoFile').files[0];
            const processBtn = document.getElementById('directProcessBtn');
            const streamStats = document.createElement('div');
            const streamVideo = document.createElement('img');
            const resultDiv = document.getElementById('directResult');

            if (!videoFile) {
                showResult(resultDiv, '请先选择视频文件', 'error');
                return;
            }

            // 设置流式显示元素
            streamStats.id = 'directProcessStats';
            streamStats.style.marginTop = '10px';
            streamStats.style.padding = '10px';
            streamStats.style.backgroundColor = '#f0f0f0';
            streamStats.style.borderRadius = '4px';
            resultDiv.parentNode.insertBefore(streamStats, resultDiv.nextSibling);
            streamStats.innerHTML = '正在准备上传文件...';

            streamVideo.id = 'directProcessVideo';
            streamVideo.style.maxWidth = '100%';
            streamVideo.style.height = 'auto';
            streamVideo.style.display = 'none';
            streamVideo.alt = '处理过程预览';
            streamStats.parentNode.insertBefore(streamVideo, streamStats.nextSibling);

            // 禁用按钮并显示加载状态
            processBtn.disabled = true;
            processBtn.textContent = '处理中...';

            try {
                // 创建 FormData 对象
                const formData = new FormData();
                formData.append('file', videoFile);

                // 构造请求URL
                const url = `${BASE_URL}/process_video?pose_type=${encodeURIComponent(poseType)}`;

                // 使用 EventSource 或 Fetch API 来处理 SSE 流
                streamStats.innerHTML = '正在连接到流式处理服务...';

                // 使用 Fetch API 和 ReadableStream 处理 SSE
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'omit'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // 处理 SSE 流
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let videoChunks = [];

                    function processStream() {
                        reader.read().then(({done, value}) => {
                            if (done) {
                                // 处理完成，创建视频下载
                                if (videoChunks.length > 0) {
                                    const processedVideoBlob = new Blob(videoChunks, { type: 'video/mp4' });
                                    const url = window.URL.createObjectURL(processedVideoBlob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `processed_${poseType}.mp4`;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    window.URL.revokeObjectURL(url);

                                    showResult(resultDiv, `
                                        视频处理成功！视频已自动下载
                                    `, 'success');
                                }

                                streamStats.innerHTML += '<br>处理完成!';
                                processBtn.disabled = false;
                                processBtn.textContent = '处理视频';
                                return;
                            }

                            // 将接收到的数据添加到缓冲区
                            buffer += decoder.decode(value, {stream: true});

                            // 处理缓冲区中的数据
                            let lines = buffer.split('\n\n');
                            buffer = lines.pop(); // 保留不完整的最后一行

                            for (const chunk of lines) {
                                if (chunk.startsWith('data: ')) {
                                    try {
                                        const jsonData = chunk.slice(6); // 去掉 'data: ' 前缀
                                        const data = JSON.parse(jsonData);

                                        switch (data.event) {
                                            case 'init':
                                                streamStats.innerHTML = `<strong>初始化:</strong> ${data.data.message}<br>`;
                                                if (data.data.fps) {
                                                    streamStats.innerHTML += `FPS: ${data.data.fps}, 分辨率: ${data.data.width}x${data.data.height}<br>`;
                                                }
                                                break;

                                            case 'frame':
                                                // 显示处理后的帧
                                                if (data.data && data.data.image) {
                                                    streamVideo.src = `data:image/jpeg;base64,${data.data.image}`;
                                                    streamVideo.style.display = 'block';
                                                } else {
                                                    console.warn('接收到的帧数据缺少image字段:', data);
                                                }
                                                streamStats.innerHTML = `
                                                    <strong>处理中...</strong><br>
                                                    当前帧: ${data.data.processed_frame_count}<br>
                                                    计数: ${data.data.count}<br>
                                                    最大计数: ${data.data.max_count}
                                                `;
                                                break;

                                            case 'final_stats':
                                                if (data.data.download_url) {
                                                    streamStats.innerHTML += `
                                                        <br><strong>处理完成!</strong><br>
                                                        最终计数: ${data.data.max_count}<br>
                                                        处理帧数: ${data.data.processed_frame_count}<br>
                                                        总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒<br>
                                                        <button onclick="window.location.href='${BASE_URL}${data.data.download_url}'">下载视频</button>
                                                    `;
                                                } else if (data.data.video_size) {
                                                    streamStats.innerHTML += `
                                                        <br><strong>处理完成!</strong><br>
                                                        最终计数: ${data.data.max_count}<br>
                                                        处理帧数: ${data.data.processed_frame_count}<br>
                                                        总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒
                                                    `;
                                                }
                                                break;

                                            case 'error':
                                                throw new Error(data.data.message);
                                        }
                                    } catch (e) {
                                        // 如果不是JSON格式，可能是视频数据的一部分
                                        // 这里我们简单地收集这些数据作为视频块
                                        videoChunks.push(value);
                                    }
                                } else {
                                    // 收集非SSE格式的数据作为视频块
                                    videoChunks.push(value);
                                }
                            }

                            // 继续处理流
                            processStream();
                        }).catch(error => {
                            console.error('Error:', error);
                            showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                            streamStats.innerHTML += `<br>错误: ${error.message}`;
                            processBtn.disabled = false;
                            processBtn.textContent = '处理视频';
                        });
                    }

                    // 开始处理流
                    processStream();
                }).catch(error => {
                    console.error('连接错误:', error);
                    showResult(resultDiv, `连接流式处理服务时发生错误: ${error.message}`, 'error');
                    streamStats.innerHTML = `错误: ${error.message}`;
                    processBtn.disabled = false;
                    processBtn.textContent = '处理视频';
                });
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                processBtn.disabled = false;
                processBtn.textContent = '处理视频';
            }
        });

        // 流式处理视频
        document.getElementById('streamProcessForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const poseType = document.getElementById('streamPoseType').value;
            const videoFile = document.getElementById('streamVideoFile').files[0];
            const processBtn = document.getElementById('streamProcessBtn');
            const streamVideo = document.getElementById('streamVideo');
            const streamStats = document.getElementById('streamStats');
            const resultDiv = document.getElementById('streamResult');

            if (!videoFile) {
                showResult(resultDiv, '请先选择视频文件', 'error');
                return;
            }

            // 禁用按钮并显示加载状态
            processBtn.disabled = true;
            processBtn.textContent = '处理中...';

            try {
                // 显示视频元素
                streamVideo.style.display = 'block';
                streamStats.innerHTML = '正在准备上传文件...';

                // 创建 FormData 对象
                const formData = new FormData();
                formData.append('file', videoFile);

                // 构造请求URL
                const url = `${BASE_URL}/stream_process_video?pose_type=${encodeURIComponent(poseType)}`;

                // 使用 EventSource 或 Fetch API 来处理 SSE 流
                streamStats.innerHTML = '正在连接到流式处理服务...';

                // 使用 Fetch API 和 ReadableStream 处理 SSE
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'omit'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // 处理 SSE 流
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processStream() {
                        reader.read().then(({done, value}) => {
                            if (done) {
                                streamStats.innerHTML += '<br>处理完成!';
                                processBtn.disabled = false;
                                processBtn.textContent = '流式处理视频';
                                return;
                            }

                            // 将接收到的数据添加到缓冲区
                            buffer += decoder.decode(value, {stream: true});

                            // 处理缓冲区中的数据
                            let lines = buffer.split('\n\n');
                            buffer = lines.pop(); // 保留不完整的最后一行

                            for (const chunk of lines) {
                                if (chunk.startsWith('data: ')) {
                                    try {
                                        const jsonData = chunk.slice(6); // 去掉 'data: ' 前缀
                                        const data = JSON.parse(jsonData);

                                        switch (data.event) {
                                            case 'init':
                                                streamStats.innerHTML = `<strong>初始化:</strong> ${data.data.message}<br>`;
                                                if (data.data.fps) {
                                                    streamStats.innerHTML += `FPS: ${data.data.fps}, 分辨率: ${data.data.width}x${data.data.height}<br>`;
                                                }
                                                break;

                                            case 'frame':
                                                // 显示处理后的帧
                                                streamVideo.src = `data:image/jpeg;base64,${data.data.image}`;
                                                streamStats.innerHTML = `
                                                    <strong>处理中...</strong><br>
                                                    当前帧: ${data.data.processed_frame_count}<br>
                                                    计数: ${data.data.count}<br>
                                                    最大计数: ${data.data.max_count}
                                                `;
                                                break;

                                            case 'final_stats':
                                                if (data.data.download_url) {
                                                    streamStats.innerHTML += `
                                                        <br><strong>处理完成!</strong><br>
                                                        最终计数: ${data.data.max_count}<br>
                                                        处理帧数: ${data.data.processed_frame_count}<br>
                                                        总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒<br>
                                                        <button onclick="window.location.href='${BASE_URL}${data.data.download_url}'">下载视频</button>
                                                    `;
                                                } else {
                                                    streamStats.innerHTML += `
                                                        <br><strong>处理完成!</strong><br>
                                                        最终计数: ${data.data.max_count}<br>
                                                        处理帧数: ${data.data.processed_frame_count}<br>
                                                        总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒
                                                    `;
                                                }
                                                showResult(resultDiv, '流式处理完成!', 'success');
                                                break;

                                            case 'error':
                                                throw new Error(data.data.message);
                                        }
                                    } catch (e) {
                                        console.error('解析数据失败:', e);
                                        streamStats.innerHTML += `<br>解析数据失败: ${e.message}`;
                                    }
                                }
                            }

                            // 继续处理流
                            processStream();
                        }).catch(error => {
                            console.error('Error:', error);
                            showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                            streamStats.innerHTML += `<br>错误: ${error.message}`;
                            processBtn.disabled = false;
                            processBtn.textContent = '流式处理视频';
                        });
                    }

                    // 开始处理流
                    processStream();
                }).catch(error => {
                    console.error('连接错误:', error);
                    showResult(resultDiv, `连接流式处理服务时发生错误: ${error.message}`, 'error');
                    streamStats.innerHTML = `错误: ${error.message}`;
                    processBtn.disabled = false;
                    processBtn.textContent = '流式处理视频';
                });
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                streamStats.innerHTML = `错误: ${error.message}`;
                processBtn.disabled = false;
                processBtn.textContent = '流式处理视频';
            }
        });

        // 处理并保存视频
        document.getElementById('saveProcessForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const homeworkId = document.getElementById('homeworkId').value;
            const studentId = document.getElementById('studentId').value;
            const poseType = document.getElementById('poseType').value;
            const videoFile = document.getElementById('videoFile').files[0];
            const processBtn = document.getElementById('saveProcessBtn');
            const streamStats = document.createElement('div');
            const streamVideo = document.createElement('img');
            const resultDiv = document.getElementById('saveResult');

            if (!videoFile) {
                showResult(resultDiv, '请先选择视频文件', 'error');
                return;
            }

            // 设置流式显示元素
            streamStats.id = 'saveProcessStats';
            streamStats.style.marginTop = '10px';
            streamStats.style.padding = '10px';
            streamStats.style.backgroundColor = '#f0f0f0';
            streamStats.style.borderRadius = '4px';
            resultDiv.parentNode.insertBefore(streamStats, resultDiv.nextSibling);
            streamStats.innerHTML = '正在准备上传文件...';

            streamVideo.id = 'saveProcessVideo';
            streamVideo.style.maxWidth = '100%';
            streamVideo.style.height = 'auto';
            streamVideo.style.display = 'none';
            streamVideo.alt = '处理过程预览';
            streamStats.parentNode.insertBefore(streamVideo, streamStats.nextSibling);

            // 禁用按钮并显示加载状态
            processBtn.disabled = true;
            processBtn.textContent = '处理中...';

            try {
                // 创建 FormData 对象
                const formData = new FormData();
                formData.append('file', videoFile);

                // 构造请求URL
                const url = `${BASE_URL}/process_and_save_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&pose_type=${encodeURIComponent(poseType)}`;

                // 使用 EventSource 或 Fetch API 来处理 SSE 流
                streamStats.innerHTML = '正在连接到流式处理服务...';

                // 使用 Fetch API 和 ReadableStream 处理 SSE
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'omit'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // 处理 SSE 流
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processStream() {
                        reader.read().then(({done, value}) => {
                            if (done) {
                                streamStats.innerHTML += '<br>处理完成!';
                                processBtn.disabled = false;
                                processBtn.textContent = '处理并保存视频';
                                return;
                            }

                            // 将接收到的数据添加到缓冲区
                            buffer += decoder.decode(value, {stream: true});

                            // 处理缓冲区中的数据
                            let lines = buffer.split('\n\n');
                            buffer = lines.pop(); // 保留不完整的最后一行

                            for (const chunk of lines) {
                                if (chunk.startsWith('data: ')) {
                                    try {
                                        const jsonData = chunk.slice(6); // 去掉 'data: ' 前缀
                                        const data = JSON.parse(jsonData);

                                        switch (data.event) {
                                            case 'init':
                                                streamStats.innerHTML = `<strong>初始化:</strong> ${data.data.message}<br>`;
                                                if (data.data.fps) {
                                                    streamStats.innerHTML += `FPS: ${data.data.fps}, 分辨率: ${data.data.width}x${data.data.height}<br>`;
                                                }
                                                break;

                                            case 'frame':
                                                // 显示处理后的帧
                                                streamVideo.src = `data:image/jpeg;base64,${data.data.image}`;
                                                streamVideo.style.display = 'block';
                                                streamStats.innerHTML = `
                                                    <strong>处理中...</strong><br>
                                                    当前帧: ${data.data.processed_frame_count}<br>
                                                    计数: ${data.data.count}<br>
                                                    最大计数: ${data.data.max_count}
                                                `;
                                                break;

                                            case 'final_stats':
                                                if (data.data.video_url) {
                                                    showResult(resultDiv, `
                                                        视频处理完成并已保存
                                                        <br>最终计数: ${data.data.max_count}
                                                        <br>处理帧数: ${data.data.processed_frame_count}
                                                        <br>总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒
                                                        <br>访问地址: <a href="${BASE_URL}${data.data.video_url}" target="_blank">点击访问</a>
                                                    `, 'success');
                                                } else {
                                                    showResult(resultDiv, `
                                                        视频处理完成并已保存
                                                        <br>最终计数: ${data.data.max_count}
                                                        <br>处理帧数: ${data.data.processed_frame_count}
                                                        <br>总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒
                                                    `, 'success');
                                                }
                                                break;

                                            case 'error':
                                                throw new Error(data.data.message);
                                        }
                                    } catch (e) {
                                        console.error('解析数据失败:', e);
                                        streamStats.innerHTML += `<br>解析数据失败: ${e.message}`;
                                    }
                                }
                            }

                            // 继续处理流
                            processStream();
                        }).catch(error => {
                            console.error('Error:', error);
                            showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                            streamStats.innerHTML += `<br>错误: ${error.message}`;
                            processBtn.disabled = false;
                            processBtn.textContent = '处理并保存视频';
                        });
                    }

                    // 开始处理流
                    processStream();
                }).catch(error => {
                    console.error('连接错误:', error);
                    showResult(resultDiv, `连接流式处理服务时发生错误: ${error.message}`, 'error');
                    streamStats.innerHTML = `错误: ${error.message}`;
                    processBtn.disabled = false;
                    processBtn.textContent = '处理并保存视频';
                });
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                processBtn.disabled = false;
                processBtn.textContent = '处理并保存视频';
            }
        });

        // 查看已处理视频
        document.getElementById('viewVideoForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const homeworkId = document.getElementById('viewHomeworkId').value;
            const studentId = document.getElementById('viewStudentId').value;
            const videoContainer = document.getElementById('processedVideoContainer');

            // 询问用户是预览还是下载
            const action = confirm("预览视频？点击'确定'预览，'取消'下载");
            const download = !action;

            console.log(`查看视频 - homeworkId: ${homeworkId}, studentId: ${studentId}, 操作: ${download ? '下载' : '预览'}`);

            try {
                const url = `${BASE_URL}/get_processed_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&download=${download}`;

                if (download) {
                    // 下载模式 - 直接创建下载链接
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `processed_video_${homeworkId}_${studentId}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    // 显示提示信息
                    const resultDiv = document.getElementById('saveResult');
                    if (resultDiv) {
                        showResult(resultDiv, `视频下载已开始: processed_video_${homeworkId}_${studentId}.mp4`, 'success');
                    }
                } else {
                    // 预览模式 - 使用流式传输
                    // 清空容器
                    if (!videoContainer) {
                        console.error('找不到视频容器元素');
                        return;
                    }
                    videoContainer.innerHTML = '';

                    // 创建canvas用于显示视频帧
                    const canvas = document.createElement('canvas');
                    canvas.id = 'viewStreamCanvas';
                    canvas.style.maxWidth = '100%';
                    canvas.style.height = 'auto';
                    canvas.style.display = 'block';
                    canvas.style.backgroundColor = '#000';

                    // 创建信息显示区域
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'viewStreamInfo';
                    infoDiv.style.marginTop = '10px';
                    infoDiv.style.padding = '10px';
                    infoDiv.style.backgroundColor = '#f0f0f0';
                    infoDiv.style.borderRadius = '4px';
                    infoDiv.innerHTML = '正在连接视频流...';

                    // 添加到容器
                    videoContainer.appendChild(canvas);
                    videoContainer.appendChild(infoDiv);

                    const ctx = canvas.getContext('2d');
                    let eventSource = null;

                    // 创建SSE连接
                    const streamUrl = `${BASE_URL}/get_processed_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&download=false`;
                    eventSource = new EventSource(streamUrl);

                    eventSource.onopen = function() {
                        infoDiv.innerHTML = '视频流连接成功，正在接收数据...';
                    };

                    eventSource.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);

                            switch (data.event) {
                                case 'video_info':
                                    const width = data.data.width !== undefined ? data.data.width : 'N/A';
                                    const height = data.data.height !== undefined ? data.data.height : 'N/A';
                                    const fps = data.data.fps !== undefined ? data.data.fps : 30;
                                    infoDiv.innerHTML = `视频信息: ${width}x${height} @ ${fps}fps`;
                                    break;

                                case 'frame':
                                    // 解码base64图像并显示
                                    const img = new Image();
                                    img.onload = function() {
                                        canvas.width = img.width;
                                        canvas.height = img.height;
                                        ctx.drawImage(img, 0, 0);
                                        const frameIndex = data.data.frame_index !== undefined ? data.data.frame_index : 'N/A';
                                        const timestamp = data.data.timestamp !== undefined ? data.data.timestamp.toFixed(2) : 'N/A';
                                        infoDiv.innerHTML = `正在播放: 第 ${frameIndex} 帧 (${timestamp}秒)`;
                                    };
                                    if (data.data && data.data.image) {
                                        img.src = `data:image/jpeg;base64,${data.data.image}`;
                                    } else {
                                        console.warn('接收到的帧数据缺少image字段:', data);
                                    }
                                    break;

                                case 'complete':
                                    infoDiv.innerHTML = '视频播放完成';
                                    eventSource.close();
                                    break;

                                case 'error':
                                    const errorMessage = data.data && data.data.message ? data.data.message : '未知错误';
                                    infoDiv.innerHTML = `错误: ${errorMessage}`;
                                    eventSource.close();
                                    alert(`视频流错误: ${errorMessage}`);
                                    break;
                            }
                        } catch (e) {
                            console.error('解析SSE数据出错:', e);
                            infoDiv.innerHTML = `解析数据出错: ${e.message}`;
                        }
                    };

                    eventSource.onerror = function(err) {
                        console.error('SSE连接错误:', err);
                        infoDiv.innerHTML = '连接错误，请重试';
                        if (eventSource) {
                            eventSource.close();
                        }
                    };

                    // 添加停止按钮
                    const stopBtn = document.createElement('button');
                    stopBtn.textContent = '停止播放';
                    stopBtn.style.marginTop = '10px';
                    stopBtn.onclick = function() {
                        if (eventSource) {
                            eventSource.close();
                            infoDiv.innerHTML = '已停止播放';
                        }
                    };
                    videoContainer.appendChild(stopBtn);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`获取视频过程中发生错误: ${error.message}`);
            }
        });

        // 删除作业
        document.getElementById('deleteHomeworkForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const homeworkId = document.getElementById('deleteHomeworkId').value;
            const deleteBtn = document.getElementById('deleteHomeworkBtn');
            const resultDiv = document.getElementById('deleteResult');

            // 确认删除操作
            if (!confirm(`确定要删除作业 ${homeworkId} 的所有视频吗？此操作不可恢复！`)) {
                return;
            }

            // 禁用按钮并显示加载状态
            deleteBtn.disabled = true;
            deleteBtn.textContent = '删除中...';

            try {
                const response = await fetch(`${BASE_URL}/delete_homework?homework_id=${encodeURIComponent(homeworkId)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(resultDiv, result.message, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`删除失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `删除过程中发生错误: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.textContent = '删除作业';
            }
        });

        // 查询作业记录
        document.getElementById('queryRecordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const homeworkId = document.getElementById('queryHomeworkId').value;
            const studentId = document.getElementById('queryStudentId').value;
            const poseType = document.getElementById('queryPoseType').value;

            try {
                // 构造查询参数
                let url = `${BASE_URL}/query_records?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}`;
                if (poseType) {
                    url += `&pose_type=${encodeURIComponent(poseType)}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const records = await response.json();
                    try {
                        displayRecords(records);
                    } catch (displayError) {
                        console.error('显示记录时出错:', displayError);
                        const queryResultElement = document.getElementById('queryResult');
                        if (queryResultElement) {
                            showResult(queryResultElement, '显示记录时出错', 'error');
                        } else {
                            alert('显示记录时出错');
                        }
                    }
                } else if (response.status === 404) {
                    const queryResultElement = document.getElementById('queryResult');
                    if (queryResultElement) {
                        showResult(queryResultElement, '未找到相关记录', 'error');
                    } else {
                        alert('未找到相关记录');
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(`查询失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                const queryResultElement = document.getElementById('queryResult');
                if (queryResultElement) {
                    showResult(queryResultElement, `查询过程中发生错误: ${error.message}`, 'error');
                } else {
                    alert(`查询过程中发生错误: ${error.message}`);
                }
            }
        });

        // 查询所有记录
        document.getElementById('queryAllRecordsBtn').addEventListener('click', async function() {
            try {
                const response = await fetch(`${BASE_URL}/query_all_records`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const records = await response.json();
                    try {
                        displayRecords(records);
                    } catch (displayError) {
                        console.error('显示记录时出错:', displayError);
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(`查询失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                const queryResultElement = document.getElementById('queryResult');
                if (queryResultElement) {
                    showResult(queryResultElement, `查询过程中发生错误: ${error.message}`, 'error');
                } else {
                    alert(`查询过程中发生错误: ${error.message}`);
                }
            }
        });

        // 显示查询结果
        function displayRecords(records) {
            const table = document.getElementById('recordsTable');
            const tbody = document.getElementById('recordsTableBody');
            const queryResultElement = document.getElementById('queryResult');

            // 清空现有数据
            tbody.innerHTML = '';

            if (records.length === 0) {
                if (queryResultElement) {
                    showResult(queryResultElement, '未找到相关记录', 'error');
                } else {
                    alert('未找到相关记录');
                }
                table.style.display = 'none';
                return;
            }

            // 填充表格数据
            records.forEach(record => {
                const row = document.createElement('tr');

                // 计算准确率
                let accuracyRate = '';
                if (record.total_count && record.total_count > 0) {
                    accuracyRate = ((record.correct_count || 0) / record.total_count * 100).toFixed(2) + '%';
                }

                // 格式化日期时间
                const uploadTime = record.uploaded_at ? new Date(record.uploaded_at).toLocaleString() : '';

                row.innerHTML = `
                    <td>${record.id || ''}</td>
                    <td>${record.homework_id || ''}</td>
                    <td>${record.student_id || ''}</td>
                    <td>${record.pose_type || ''}</td>
                    <td>${uploadTime}</td>
                    <td>${record.total_count !== null ? record.total_count : ''}</td>
                    <td>${record.correct_count !== null ? record.correct_count : ''}</td>
                    <td>${record.incorrect_count !== null ? record.incorrect_count : ''}</td>
                    <td>${accuracyRate}</td>
                    <td>${record.video_duration !== null ? parseFloat(record.video_duration).toFixed(2) : ''}</td>
                    <td>
                        <button onclick="viewRecordDetails(${record.id})" style="padding: 4px 8px; margin: 2px;">详情</button>
                        <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', false)" style="padding: 4px 8px; margin: 2px;">预览</button>
                        <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', true)" style="padding: 4px 8px; margin: 2px;">下载</button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // 显示表格
            table.style.display = 'table';
            if (queryResultElement) {
                queryResultElement.className = 'result success';
                queryResultElement.style.display = 'block';
            }
        }

        // 显示结果消息
        function showResult(element, message, type) {
            // 检查元素是否存在
            if (element) {
                element.innerHTML = message;
                element.className = `result ${type}`;
                element.style.display = 'block';
            } else {
                // 如果元素不存在，输出到控制台
                console.warn('试图设置不存在的元素:', message);
            }
        }

        // 获取记录详情
        async function getRecordDetails() {
            const recordId = document.getElementById('recordId').value;
            const detailsDiv = document.getElementById('recordDetails');
            
            if (!recordId) {
                showResult(detailsDiv, '请输入记录ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/get_record_details/${recordId}`);
                if (response.ok) {
                    const record = await response.json();
                    displayRecordDetails(record);
                } else {
                    const errorText = await response.text();
                    throw new Error(`获取记录详情失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(detailsDiv, `获取记录详情时发生错误: ${error.message}`, 'error');
            }
        }

        // 通过作业ID和学生ID获取记录详情
        async function getRecordDetailsByHomeworkStudent() {
            const homeworkId = document.getElementById('detailHomeworkId').value;
            const studentId = document.getElementById('detailStudentId').value;
            const detailsDiv = document.getElementById('recordDetailsByHomeworkStudent');
            
            if (!homeworkId || !studentId) {
                showResult(detailsDiv, '请输入作业ID和学生ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/get_record_details?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}`);
                if (response.ok) {
                    const records = await response.json();
                    displayMultipleRecordDetails(records, 'recordDetailsByHomeworkStudent');
                } else if (response.status === 404) {
                    showResult(detailsDiv, '未找到相关记录', 'error');
                } else {
                    const errorText = await response.text();
                    throw new Error(`获取记录详情失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(detailsDiv, `获取记录详情时发生错误: ${error.message}`, 'error');
            }
        }

        // 显示记录详情
        function displayRecordDetails(record) {
            const detailsDiv = document.getElementById('recordDetails');
            
            let html = `
                <h3>记录详情 (ID: ${record.id})</h3>
                <div class="record-details-grid">
                    <div><strong>作业ID:</strong> ${record.homework_id || ''}</div>
                    <div><strong>学生ID:</strong> ${record.student_id || ''}</div>
                    <div><strong>动作类型:</strong> ${record.pose_type || ''}</div>
                    <div><strong>上传时间:</strong> ${new Date(record.uploaded_at).toLocaleString() || ''}</div>
                    <div><strong>总次数:</strong> ${record.total_count || 0}</div>
                    <div><strong>正确次数:</strong> ${record.correct_count || 0}</div>
                    <div><strong>错误次数:</strong> ${record.incorrect_count || 0}</div>
                    <div><strong>准确率:</strong> ${record.total_count > 0 ? ((record.correct_count || 0) / record.total_count * 100).toFixed(2) + '%' : '0%'}</div>
                    <div><strong>视频时长:</strong> ${record.video_duration ? parseFloat(record.video_duration).toFixed(2) + '秒' : ''}</div>
                    <div><strong>原始视频路径:</strong> ${record.original_video_path || ''}</div>
                    <div><strong>处理后视频路径:</strong> ${record.processed_video_path || ''}</div>
            `;
            
            // 解析并显示反馈详情
            if (record.feedback_json) {
                try {
                    const feedback = JSON.parse(record.feedback_json);
                    html += `<div class="feedback-details"><strong>反馈详情:</strong><pre>${JSON.stringify(feedback, null, 2)}</pre></div>`;
                } catch (e) {
                    html += `<div><strong>反馈详情:</strong> ${record.feedback_json}</div>`;
                }
            }
            
            html += `
                </div>
                <button onclick="downloadRecordData('${record.id}')">下载JSON数据</button>
                <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', false)">预览视频</button>
                <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', true)">下载视频</button>
            `;
            
            detailsDiv.innerHTML = html;
            detailsDiv.className = 'result success';
            detailsDiv.style.display = 'block';
        }

        // 显示多个记录详情
        function displayMultipleRecordDetails(records) {
            const detailsDiv = document.getElementById('recordDetails');
            
            if (!records || records.length === 0) {
                showResult(detailsDiv, '未找到相关记录', 'error');
                return;
            }
            
            let html = '<h3>记录详情</h3>';
            
            records.forEach(record => {
                html += `
                    <div class="record-details-grid">
                        <div><strong>记录ID:</strong> ${record.id || ''}</div>
                        <div><strong>作业ID:</strong> ${record.homework_id || ''}</div>
                        <div><strong>学生ID:</strong> ${record.student_id || ''}</div>
                        <div><strong>动作类型:</strong> ${record.pose_type || ''}</div>
                        <div><strong>上传时间:</strong> ${new Date(record.uploaded_at).toLocaleString() || ''}</div>
                        <div><strong>总次数:</strong> ${record.total_count || 0}</div>
                        <div><strong>正确次数:</strong> ${record.correct_count || 0}</div>
                        <div><strong>错误次数:</strong> ${record.incorrect_count || 0}</div>
                        <div><strong>准确率:</strong> ${record.total_count > 0 ? ((record.correct_count || 0) / record.total_count * 100).toFixed(2) + '%' : '0%'}</div>
                        <div><strong>视频时长:</strong> ${record.video_duration ? parseFloat(record.video_duration).toFixed(2) + '秒' : ''}</div>
                        <div><strong>原始视频路径:</strong> ${record.original_video_path || ''}</div>
                        <div><strong>处理后视频路径:</strong> ${record.processed_video_path || ''}</div>
                `;
                
                // 解析并显示反馈详情
                if (record.feedback_json) {
                    try {
                        const feedback = JSON.parse(record.feedback_json);
                        html += `<div class="feedback-details"><strong>反馈详情:</strong><pre>${JSON.stringify(feedback, null, 2)}</pre></div>`;
                    } catch (e) {
                        html += `<div><strong>反馈详情:</strong> ${record.feedback_json}</div>`;
                    }
                }
                
                html += `
                        <div>
                            <button onclick="downloadRecordData('${record.id}')" style="margin-right: 10px;">下载JSON数据</button>
                            <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', false)" style="margin-right: 5px;">预览视频</button>
                            <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', true)">下载视频</button>
                        </div>
                    </div>
                    <hr>
                `;
            });
            
            detailsDiv.innerHTML = html;
            detailsDiv.className = 'result success';
            detailsDiv.style.display = 'block';
        }

        // 下载记录数据为JSON文件
        function downloadRecordData(recordId) {
            fetch(`${BASE_URL}/get_record_details/${recordId}`)
                .then(response => response.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `record_${recordId}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(`下载数据失败: ${error.message}`);
                });
        }

        // 查看处理后的视频
        function viewProcessedVideo(homeworkId, studentId, download = false) {
            const videoUrl = `${BASE_URL}/get_processed_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&download=${download}`;

            if (download) {
                // 下载模式 - 保持不变
                const a = document.createElement('a');
                a.href = videoUrl;
                a.download = `processed_video_${homeworkId}_${studentId}.mp4`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // 显示提示
                alert(`视频下载已开始: processed_video_${homeworkId}_${studentId}.mp4`);
            } else {
                // 预览模式 - 使用SSE流
                startSimpleVideoStream(homeworkId, studentId);
            }
        }

        function startSimpleVideoStream(homeworkId, studentId) {
            console.log(`开始SSE视频流: homeworkId=${homeworkId}, studentId=${studentId}`);

            // 清空视频容器
            const videoContainer = document.getElementById('processedVideoContainer');
            if (!videoContainer) {
                console.error('找不到视频容器元素');
                return;
            }
            videoContainer.innerHTML = '';

            // 创建Canvas
            const canvas = document.createElement('canvas');
            canvas.id = 'video-canvas';
            canvas.style.width = '100%';
            canvas.style.maxWidth = '640px';
            canvas.style.height = 'auto';
            canvas.style.backgroundColor = '#000';
            canvas.style.display = 'block';

            // 创建状态显示
            const statusDiv = document.createElement('div');
            statusDiv.id = 'stream-status';
            statusDiv.style.padding = '10px';
            statusDiv.style.backgroundColor = '#f0f0f0';
            statusDiv.style.borderRadius = '4px';
            statusDiv.style.margin = '10px 0';
            statusDiv.textContent = '正在连接视频流...';

            // 添加到容器
            videoContainer.appendChild(canvas);
            videoContainer.appendChild(statusDiv);

            const ctx = canvas.getContext('2d');
            let frameCount = 0;
            let startTime = Date.now();

            // SSE URL
            const streamUrl = `${BASE_URL}/get_processed_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&download=false`;

            console.log('SSE URL:', streamUrl);

            // 创建EventSource
            const eventSource = new EventSource(streamUrl);

            // 保存引用以便停止
            window.currentVideoStream = eventSource;

            eventSource.onopen = function() {
                console.log('SSE连接已建立');
                statusDiv.textContent = '视频流连接成功...';
            };

            eventSource.onmessage = function(event) {
                try {
                    // 解析JSON数据
                    const data = JSON.parse(event.data);
                    console.log('收到SSE事件:', data.event);

                    switch (data.event) {
                        case 'video_info':
                            statusDiv.textContent = `视频信息: ${data.data.width}x${data.data.height} @ ${data.data.fps || 30}fps`;
                            console.log('视频信息:', data);
                            break;

                        case 'frame':
                            // 解码base64图像并显示
                            try {
                                const img = new Image();
                                img.onload = function() {
                                    // 设置canvas尺寸匹配图像
                                    canvas.width = img.width;
                                    canvas.height = img.height;

                                    // 绘制图像
                                    ctx.drawImage(img, 0, 0);

                                    // 更新状态
                                    frameCount++;
                                    const elapsed = (Date.now() - startTime) / 1000;
                                    const fps = (frameCount / elapsed).toFixed(1);

                                    const frameIndex = data.data.frame_index !== undefined ? data.data.frame_index : 'N/A';
                                    const timestamp = data.data.timestamp !== undefined ? data.data.timestamp.toFixed(2) + '秒' : 'N/A';
                                    statusDiv.innerHTML = `
                                        正在播放: 第${frameIndex}帧<br>
                                        时间: ${timestamp}<br>
                                        实时FPS: ${fps}<br>
                                        总帧数: ${frameCount}
                                    `;
                                };
                                img.onerror = function() {
                                    console.error('图像加载失败');
                                };

                                // 使用image字段而不是data字段
                                if (data.data && data.data.image) {
                                    img.src = `data:image/jpeg;base64,${data.data.image}`;
                                } else {
                                    console.warn('接收到的帧数据缺少image字段:', data);
                                }
                            } catch (imgError) {
                                console.error('处理图像失败:', imgError);
                            }
                            break;

                        case 'complete':
                            const totalFrames = data.data.total_frames_sent !== undefined ? data.data.total_frames_sent : 'N/A';
                            statusDiv.textContent = `视频播放完成 - 总共${totalFrames}帧`;
                            eventSource.close();
                            break;

                        case 'error':
                            const errorMessage = data.data.message !== undefined ? data.data.message : '未知错误';
                            statusDiv.innerHTML = `<span style="color: red">错误: ${errorMessage}</span>`;
                            console.error('SSE错误:', errorMessage);
                            eventSource.close();
                            break;

                        default:
                            console.log('未知事件类型:', data.event);
                    }
                } catch (parseError) {
                    console.error('解析SSE数据失败:', parseError, '原始数据:', event.data);
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE连接错误:', error);
                statusDiv.innerHTML = '<span style="color: red">连接错误，请重试</span>';
                eventSource.close();
            };

            // 添加停止按钮
            const stopBtn = document.createElement('button');
            stopBtn.textContent = '停止播放';
            stopBtn.style.marginTop = '10px';
            stopBtn.style.padding = '8px 16px';
            stopBtn.style.backgroundColor = '#f44336';
            stopBtn.style.color = 'white';
            stopBtn.style.border = 'none';
            stopBtn.style.borderRadius = '4px';
            stopBtn.style.cursor = 'pointer';

            stopBtn.onclick = function() {
                if (eventSource) {
                    eventSource.close();
                    statusDiv.textContent = '已停止播放';
                    console.log('视频流已停止');
                }
            };

            videoContainer.appendChild(stopBtn);

            // 添加下载按钮
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '下载完整视频';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.marginLeft = '10px';
            downloadBtn.style.padding = '8px 16px';
            downloadBtn.style.backgroundColor = '#4CAF50';
            downloadBtn.style.color = 'white';
            downloadBtn.style.border = 'none';
            downloadBtn.style.borderRadius = '4px';
            downloadBtn.style.cursor = 'pointer';

            downloadBtn.onclick = function() {
                const downloadUrl = `${BASE_URL}/get_processed_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&download=true`;
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `processed_video_${homeworkId}_${studentId}.mp4`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            videoContainer.appendChild(downloadBtn);
        }

        // 查看记录详情
        function viewRecordDetails(recordId) {
            document.getElementById('recordId').value = recordId;
            getRecordDetails();
        }

        // 获取指定学生的所有记录（新接口测试）
        async function getStudentAllRecords() {
            const studentId = document.getElementById('studentIdForAllRecords').value.trim();
            
            if (!studentId) {
                alert('请输入学生ID');
                return;
            }
            
            const detailsDiv = document.getElementById('allRecordsDetails');
            showResult(detailsDiv, '正在获取学生所有记录...', 'success');
            
            try {
                const response = await fetch(`${BASE_URL}/api/student/all-records/${encodeURIComponent(studentId)}`);
                
                if (response.ok) {
                    const records = await response.json();
                    displayMultipleRecordDetails(records, 'allRecordsDetails');
                } else if (response.status === 404) {
                    showResult(detailsDiv, '未找到该学生记录', 'error');
                } else {
                    const errorText = await response.text();
                    throw new Error(`获取学生记录失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(detailsDiv, `获取学生记录时发生错误: ${error.message}`, 'error');
            }
        }

        // 显示多个记录详情（保留向后兼容性）
        function displayMultipleRecordDetails(records, containerId = 'recordDetails') {
            const detailsDiv = document.getElementById(containerId);
            
            if (!records || records.length === 0) {
                showResult(detailsDiv, '未找到相关记录', 'error');
                return;
            }
            
            let html = '<h3>记录详情</h3>';
            
            records.forEach(record => {
                html += `
                    <div class="record-details-grid">
                        <div><strong>记录ID:</strong> ${record.id || ''}</div>
                        <div><strong>作业ID:</strong> ${record.homework_id || ''}</div>
                        <div><strong>学生ID:</strong> ${record.student_id || ''}</div>
                        <div><strong>动作类型:</strong> ${record.pose_type || ''}</div>
                        <div><strong>上传时间:</strong> ${new Date(record.uploaded_at).toLocaleString() || ''}</div>
                        <div><strong>总次数:</strong> ${record.total_count || 0}</div>
                        <div><strong>正确次数:</strong> ${record.correct_count || 0}</div>
                        <div><strong>错误次数:</strong> ${record.incorrect_count || 0}</div>
                        <div><strong>准确率:</strong> ${record.total_count > 0 ? ((record.correct_count || 0) / record.total_count * 100).toFixed(2) + '%' : '0%'}</div>
                        <div><strong>视频时长:</strong> ${record.video_duration ? parseFloat(record.video_duration).toFixed(2) + '秒' : ''}</div>
                        <div><strong>原始视频路径:</strong> ${record.original_video_path || ''}</div>
                        <div><strong>处理后视频路径:</strong> ${record.processed_video_path || ''}</div>
                `;
                
                // 解析并显示反馈详情
                if (record.feedback_json) {
                    try {
                        const feedback = JSON.parse(record.feedback_json);
                        html += `<div class="feedback-details"><strong>反馈详情:</strong><pre>${JSON.stringify(feedback, null, 2)}</pre></div>`;
                    } catch (e) {
                        html += `<div><strong>反馈详情:</strong> ${record.feedback_json}</div>`;
                    }
                }
                
                html += `
                        <div>
                            <button onclick="downloadRecordData('${record.id}')" style="margin-right: 10px;">下载JSON数据</button>
                            <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', false)" style="margin-right: 5px;">预览视频</button>
                            <button onclick="viewProcessedVideo('${record.homework_id}', '${record.student_id}', true)">下载视频</button>
                        </div>
                    </div>
                    <hr>
                `;
            });
            
            detailsDiv.innerHTML = html;
            detailsDiv.className = 'result success';
            detailsDiv.style.display = 'block';
        }
    </script>
</body>
</html>