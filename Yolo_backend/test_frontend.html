<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI健身助手 - 视频处理测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .video-container {
            margin-top: 20px;
            text-align: center;
        }
        video {
            max-width: 100%;
            height: auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .section-title {
            margin-top: 0;
            color: #555;
        }
        #streamVideo {
            width: 100%;
            max-width: 640px;
            height: auto;
            background-color: #000;
        }
        #streamStats {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI健身助手 - 视频处理测试</h1>
        
        <!-- 现有功能测试 -->
        <div class="section">
            <h2 class="section-title">直接处理视频</h2>
            <form id="directProcessForm">
                <div class="form-group">
                    <label for="directPoseType">动作类型:</label>
                    <select id="directPoseType">
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="abworkout">腹肌训练</option>
                        <option value="deadlift">硬拉</option>
                        <option value="benchpress">卧推</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="directVideoFile">选择视频:</label>
                    <input type="file" id="directVideoFile" accept="video/*" required>
                </div>
                <button type="submit" id="directProcessBtn">处理视频</button>
            </form>
            <div id="directResult" class="result"></div>
        </div>
        
        <!-- 流式处理视频 -->
        <div class="section">
            <h2 class="section-title">流式处理视频 (新功能)</h2>
            <form id="streamProcessForm">
                <div class="form-group">
                    <label for="streamPoseType">动作类型:</label>
                    <select id="streamPoseType">
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="abworkout">腹肌训练</option>
                        <option value="deadlift">硬拉</option>
                        <option value="benchpress">卧推</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="streamVideoFile">选择视频:</label>
                    <input type="file" id="streamVideoFile" accept="video/*" required>
                </div>
                <button type="submit" id="streamProcessBtn">流式处理视频</button>
            </form>
            <div class="video-container">
                <img id="streamVideo" alt="流式视频处理结果" style="display: none;">
            </div>
            <div id="streamStats"></div>
            <div id="streamResult" class="result"></div>
        </div>
        
        <!-- 新功能测试 -->
        <div class="section">
            <h2 class="section-title">处理并保存视频（新功能）</h2>
            <form id="saveProcessForm">
                <div class="form-group">
                    <label for="homeworkId">作业ID:</label>
                    <input type="text" id="homeworkId" placeholder="请输入作业ID" required>
                </div>
                <div class="form-group">
                    <label for="studentId">学生ID:</label>
                    <input type="text" id="studentId" placeholder="请输入学生ID" required>
                </div>
                <div class="form-group">
                    <label for="poseType">动作类型:</label>
                    <select id="poseType">
                        <option value="pushup">俯卧撑</option>
                        <option value="squat">深蹲</option>
                        <option value="abworkout">腹肌训练</option>
                        <option value="deadlift">硬拉</option>
                        <option value="benchpress">卧推</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="videoFile">选择视频:</label>
                    <input type="file" id="videoFile" accept="video/*" required>
                </div>
                <button type="submit" id="saveProcessBtn">处理并保存视频</button>
            </form>
            <div id="saveResult" class="result"></div>
        </div>
        
        <!-- 查看已处理视频 -->
        <div class="section">
            <h2 class="section-title">查看已处理视频</h2>
            <form id="viewVideoForm">
                <div class="form-group">
                    <label for="viewHomeworkId">作业ID:</label>
                    <input type="text" id="viewHomeworkId" placeholder="请输入作业ID" required>
                </div>
                <div class="form-group">
                    <label for="viewStudentId">学生ID:</label>
                    <input type="text" id="viewStudentId" placeholder="请输入学生ID" required>
                </div>
                <button type="submit" id="viewVideoBtn">查看视频</button>
            </form>
            <div class="video-container">
                <video id="processedVideo" controls style="display: none;">
                    您的浏览器不支持视频标签。
                </video>
            </div>
        </div>
        
        <!-- 删除作业 -->
        <div class="section">
            <h2 class="section-title">删除作业</h2>
            <form id="deleteHomeworkForm">
                <div class="form-group">
                    <label for="deleteHomeworkId">作业ID:</label>
                    <input type="text" id="deleteHomeworkId" placeholder="请输入要删除的作业ID" required>
                </div>
                <button type="submit" id="deleteHomeworkBtn">删除作业</button>
            </form>
            <div id="deleteResult" class="result"></div>
        </div>
    </div>

    <script>
        // 设置基础URL
        const BASE_URL = 'http://localhost:8000';
        
        // 直接处理视频
        document.getElementById('directProcessForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const poseType = document.getElementById('directPoseType').value;
            const videoFile = document.getElementById('directVideoFile').files[0];
            const processBtn = document.getElementById('directProcessBtn');
            const resultDiv = document.getElementById('directResult');
            
            if (!videoFile) {
                showResult(resultDiv, '请先选择视频文件', 'error');
                return;
            }
            
            // 禁用按钮并显示加载状态
            processBtn.disabled = true;
            processBtn.textContent = '处理中...';
            
            try {
                const formData = new FormData();
                formData.append('file', videoFile);
                
                const response = await fetch(`${BASE_URL}/process_video?pose_type=${encodeURIComponent(poseType)}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // 获取响应头中的统计数据
                    const finalCount = response.headers.get('X-Final-Count');
                    const totalFrames = response.headers.get('X-Total-Frames');
                    const totalTime = response.headers.get('X-Total-Time');
                    
                    // 创建下载链接
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `processed_${poseType}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showResult(resultDiv, `
                        视频处理成功！
                        <br>最终计数: ${finalCount}
                        <br>总帧数: ${totalFrames}
                        <br>总时间: ${parseFloat(totalTime).toFixed(2)} 秒
                        <br>视频已自动下载
                    `, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`处理失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `处理过程中发生错误: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                processBtn.disabled = false;
                processBtn.textContent = '处理视频';
            }
        });
        
        // 流式处理视频
        document.getElementById('streamProcessForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const poseType = document.getElementById('streamPoseType').value;
            const videoFile = document.getElementById('streamVideoFile').files[0];
            const processBtn = document.getElementById('streamProcessBtn');
            const streamVideo = document.getElementById('streamVideo');
            const streamStats = document.getElementById('streamStats');
            const resultDiv = document.getElementById('streamResult');
            
            if (!videoFile) {
                showResult(resultDiv, '请先选择视频文件', 'error');
                return;
            }
            
            // 禁用按钮并显示加载状态
            processBtn.disabled = true;
            processBtn.textContent = '处理中...';
            
            try {
                // 显示视频元素
                streamVideo.style.display = 'block';
                streamStats.innerHTML = '正在准备上传文件...';
                
                // 创建 FormData 对象
                const formData = new FormData();
                formData.append('file', videoFile);
                
                // 构造请求URL
                const url = `${BASE_URL}/stream_process_video?pose_type=${encodeURIComponent(poseType)}`;
                
                // 使用 EventSource 或 Fetch API 来处理 SSE 流
                streamStats.innerHTML = '正在连接到流式处理服务...';
                
                // 使用 Fetch API 和 ReadableStream 处理 SSE
                fetch(url, {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // 处理 SSE 流
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    function processStream() {
                        reader.read().then(({done, value}) => {
                            if (done) {
                                streamStats.innerHTML += '<br>处理完成!';
                                processBtn.disabled = false;
                                processBtn.textContent = '流式处理视频';
                                return;
                            }
                            
                            // 将接收到的数据添加到缓冲区
                            buffer += decoder.decode(value, {stream: true});
                            
                            // 处理缓冲区中的数据
                            let lines = buffer.split('\n\n');
                            buffer = lines.pop(); // 保留不完整的最后一行
                            
                            for (const chunk of lines) {
                                if (chunk.startsWith('data: ')) {
                                    try {
                                        const jsonData = chunk.slice(6); // 去掉 'data: ' 前缀
                                        const data = JSON.parse(jsonData);
                                        
                                        switch (data.event) {
                                            case 'init':
                                                streamStats.innerHTML = `<strong>初始化:</strong> ${data.data.message}<br>`;
                                                if (data.data.fps) {
                                                    streamStats.innerHTML += `FPS: ${data.data.fps}, 分辨率: ${data.data.width}x${data.data.height}<br>`;
                                                }
                                                break;
                                                
                                            case 'frame':
                                                // 显示处理后的帧
                                                streamVideo.src = `data:image/jpeg;base64,${data.data.image}`;
                                                streamStats.innerHTML = `
                                                    <strong>处理中...</strong><br>
                                                    当前帧: ${data.data.processed_frame_count}<br>
                                                    计数: ${data.data.count}<br>
                                                    最大计数: ${data.data.max_count}
                                                `;
                                                break;
                                                
                                            case 'final_stats':
                                                if (data.data.download_url) {
                                                    streamStats.innerHTML += `
                                                        <br><strong>处理完成!</strong><br>
                                                        最终计数: ${data.data.max_count}<br>
                                                        处理帧数: ${data.data.processed_frame_count}<br>
                                                        总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒<br>
                                                        <button onclick="window.location.href='${BASE_URL}${data.data.download_url}'">下载视频</button>
                                                    `;
                                                } else {
                                                    streamStats.innerHTML += `
                                                        <br><strong>处理完成!</strong><br>
                                                        最终计数: ${data.data.max_count}<br>
                                                        处理帧数: ${data.data.processed_frame_count}<br>
                                                        总时间: ${parseFloat(data.data.total_time).toFixed(2)} 秒
                                                    `;
                                                }
                                                showResult(resultDiv, '流式处理完成!', 'success');
                                                break;
                                                
                                            case 'error':
                                                throw new Error(data.data.message);
                                        }
                                    } catch (e) {
                                        console.error('解析数据失败:', e);
                                        streamStats.innerHTML += `<br>解析数据失败: ${e.message}`;
                                    }
                                }
                            }
                            
                            // 继续处理流
                            processStream();
                        }).catch(error => {
                            console.error('Error:', error);
                            showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                            streamStats.innerHTML += `<br>错误: ${error.message}`;
                            processBtn.disabled = false;
                            processBtn.textContent = '流式处理视频';
                        });
                    }
                    
                    // 开始处理流
                    processStream();
                }).catch(error => {
                    console.error('连接错误:', error);
                    showResult(resultDiv, `连接流式处理服务时发生错误: ${error.message}`, 'error');
                    streamStats.innerHTML = `错误: ${error.message}`;
                    processBtn.disabled = false;
                    processBtn.textContent = '流式处理视频';
                });
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `流式处理过程中发生错误: ${error.message}`, 'error');
                streamStats.innerHTML = `错误: ${error.message}`;
                processBtn.disabled = false;
                processBtn.textContent = '流式处理视频';
            }
        });
        
        // 处理并保存视频（新功能）
        document.getElementById('saveProcessForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const homeworkId = document.getElementById('homeworkId').value;
            const studentId = document.getElementById('studentId').value;
            const poseType = document.getElementById('poseType').value;
            const videoFile = document.getElementById('videoFile').files[0];
            const processBtn = document.getElementById('saveProcessBtn');
            const resultDiv = document.getElementById('saveResult');
            
            if (!videoFile) {
                showResult(resultDiv, '请先选择视频文件', 'error');
                return;
            }
            
            // 禁用按钮并显示加载状态
            processBtn.disabled = true;
            processBtn.textContent = '处理中...';
            
            try {
                const formData = new FormData();
                formData.append('file', videoFile);
                
                const response = await fetch(`${BASE_URL}/process_and_save_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}&pose_type=${encodeURIComponent(poseType)}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult(resultDiv, `
                        ${result.message}
                        <br>最终计数: ${result.final_count}
                        <br>总帧数: ${result.total_frames}
                        <br>总时间: ${parseFloat(result.total_time).toFixed(2)} 秒
                        <br>访问地址: <a href="${result.video_url}" target="_blank">点击访问</a>
                    `, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`处理失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `处理过程中发生错误: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                processBtn.disabled = false;
                processBtn.textContent = '处理并保存视频';
            }
        });
        
        // 查看已处理视频
        document.getElementById('viewVideoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const homeworkId = document.getElementById('viewHomeworkId').value;
            const studentId = document.getElementById('viewStudentId').value;
            const videoElement = document.getElementById('processedVideo');
            
            try {
                const response = await fetch(`${BASE_URL}/get_processed_video?homework_id=${encodeURIComponent(homeworkId)}&student_id=${encodeURIComponent(studentId)}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    videoElement.src = url;
                    videoElement.style.display = 'block';
                } else if (response.status === 404) {
                    alert('未找到视频文件，请确认作业ID和学生ID是否正确');
                } else {
                    const errorText = await response.text();
                    throw new Error(`获取视频失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`获取视频过程中发生错误: ${error.message}`);
            }
        });
        
        // 删除作业
        document.getElementById('deleteHomeworkForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const homeworkId = document.getElementById('deleteHomeworkId').value;
            const deleteBtn = document.getElementById('deleteHomeworkBtn');
            const resultDiv = document.getElementById('deleteResult');
            
            // 确认删除操作
            if (!confirm(`确定要删除作业 ${homeworkId} 的所有视频吗？此操作不可恢复！`)) {
                return;
            }
            
            // 禁用按钮并显示加载状态
            deleteBtn.disabled = true;
            deleteBtn.textContent = '删除中...';
            
            try {
                const response = await fetch(`${BASE_URL}/delete_homework?homework_id=${encodeURIComponent(homeworkId)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult(resultDiv, result.message, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`删除失败: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(resultDiv, `删除过程中发生错误: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.textContent = '删除作业';
            }
        });
        
        // 显示结果消息
        function showResult(element, message, type) {
            element.innerHTML = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>